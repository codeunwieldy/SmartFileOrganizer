<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="SmartFileOrganizer.App.Pages.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:SmartFileOrganizer.App.ViewModels"
    xmlns:ctrls="clr-namespace:SmartFileOrganizer.App.Pages.Controls"
    xmlns:local="clr-namespace:SmartFileOrganizer.App"
	xmlns:conv="clr-namespace:SmartFileOrganizer.App.Converters"
    x:Name="MainRoot"
    Title="Smart File Organizer"
    x:DataType="vm:MainViewModel">

	<!-- add this -->
	<ContentPage.Resources>
		<ResourceDictionary>
			<conv:InverseBoolConverter x:Key="InverseBoolConverter" />
		</ResourceDictionary>
	</ContentPage.Resources>

	<ScrollView>
		<VerticalStackLayout Spacing="14" Padding="20">
			<Label Text="Choose Mode" FontSize="20" />

			<!-- Mode buttons -->
			<Grid ColumnDefinitions="*,*,*">
				<Button Text="Desktop"
                        Command="{Binding GeneratePlanCommand}"
                        CommandParameter="desktop" />
				<Button Grid.Column="1"
                        Text="Downloads"
                        Command="{Binding GeneratePlanCommand}"
                        CommandParameter="downloads" />
				<Button Grid.Column="2"
                        Text="Everything"
                        Command="{Binding GeneratePlanCommand}"
                        CommandParameter="all" />
			</Grid>

			<!-- Busy + status -->
			<Grid ColumnDefinitions="*,*" ColumnSpacing="8" VerticalOptions="Center"
                  IsVisible="{Binding IsProgressVisible}">

				<!-- determinate bar -->
				<ProgressBar Grid.ColumnSpan="2"
                             IsVisible="{Binding IsIndeterminate, Converter={StaticResource InverseBoolConverter}}"
                             Progress="{Binding ProgressValue}"
                             HeightRequest="6"
                             AutomationProperties.Name="File scan progress" />

				<!-- indeterminate spinner -->
				<ActivityIndicator Grid.ColumnSpan="2"
                                   IsVisible="{Binding IsIndeterminate}"
                                   IsRunning="{Binding IsIndeterminate}" />

				<Label Grid.Column="0" Text="{Binding StatusText}" LineBreakMode="TailTruncation" />
				<Label Grid.Column="1" Text="{Binding SubStatusText}" LineBreakMode="TailTruncation" />
			</Grid>


			<!-- Tiny console of recent progress lines -->
			<Border StrokeThickness="1" Stroke="#33000000" Padding="6" IsVisible="{Binding IsProgressVisible}">
				<VerticalStackLayout Spacing="4">
					<Label Text="Progress" FontAttributes="Bold" FontSize="12"/>
					<CollectionView x:Name="ProgressList"
                                    HeightRequest="140"
                                    ItemsSource="{Binding ProgressLines}">
						<CollectionView.ItemsLayout>
							<LinearItemsLayout Orientation="Vertical" ItemSpacing="2"/>
						</CollectionView.ItemsLayout>
						<CollectionView.ItemTemplate>
							<DataTemplate>
								<Label Text="{Binding .}" FontSize="12" LineBreakMode="TailTruncation"/>
							</DataTemplate>
						</CollectionView.ItemTemplate>
					</CollectionView>
				</VerticalStackLayout>
			</Border>

			<!-- Main actions -->
			<Grid ColumnDefinitions="*,*" RowDefinitions="Auto">
				<Button Text="One-click Clean" Command="{Binding ExecuteCommand}" />
				<Button Grid.Column="1" Text="Revert" Command="{Binding RevertCommand}" />
			</Grid>

			<!-- Folder actions -->
			<HorizontalStackLayout Spacing="8">
				<Button Text="Choose Folders…" Command="{Binding AddFolderCommand}" />
				<Button Text="Cancel" Command="{Binding CancelOpsCommand}" IsEnabled="{Binding IsBusy}" />
			</HorizontalStackLayout>

			<!-- Selected roots chips -->
			<FlexLayout Direction="Row" Wrap="Wrap" AlignItems="Center" Margin="0,8,0,0"
                        BindableLayout.ItemsSource="{Binding SelectedRoots}">
				<BindableLayout.ItemTemplate>
					<DataTemplate>
						<Border Padding="6" Margin="4" Background="#1A000000">
							<Border.StrokeShape>
								<RoundRectangle CornerRadius="12" />
							</Border.StrokeShape>
							<HorizontalStackLayout Spacing="6">
								<Label Text="{Binding .}" LineBreakMode="TailTruncation" />
								<Button Text="×"
                                        Padding="0"
                                        Command="{Binding Source={x:Reference MainRoot}, Path=BindingContext.RemoveRootCommand}"
                                        CommandParameter="{Binding .}" />
							</HorizontalStackLayout>
						</Border>
					</DataTemplate>
				</BindableLayout.ItemTemplate>
			</FlexLayout>

			<!-- Organization preferences -->
			<Border Padding="10" Margin="0,8,0,8" Stroke="#33000000" StrokeThickness="1">
				<Border.StrokeShape>
					<RoundRectangle CornerRadius="10" />
				</Border.StrokeShape>
				<VerticalStackLayout Spacing="6">
					<Label Text="Organization preferences" FontAttributes="Bold" />
					<Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnSpacing="10" RowSpacing="6">
						<Switch Grid.Row="0" Grid.Column="0" IsToggled="{Binding Preferences.GroupByType}" Toggled="OnPrefChanged"/>
						<Label  Grid.Row="0" Grid.Column="1" Text="Group by Type (Images, Docs, Archives…)" />

						<Switch Grid.Row="1" Grid.Column="0" IsToggled="{Binding Preferences.GroupByDate}" Toggled="OnPrefChanged"/>
						<Label  Grid.Row="1" Grid.Column="1" Text="Group by Date (YYYY / YYYY-MM)" />

						<Switch Grid.Row="2" Grid.Column="0" IsToggled="{Binding Preferences.GroupByProject}" Toggled="OnPrefChanged"/>
						<Label  Grid.Row="2" Grid.Column="1" Text="Group by Project (infer from names/paths)" />

						<Switch Grid.Row="3" Grid.Column="0" IsToggled="{Binding Preferences.KeepFolderNames}" Toggled="OnPrefChanged"/>
						<Label  Grid.Row="3" Grid.Column="1" Text="Prefer existing folder names" />

						<Switch Grid.Row="4" Grid.Column="0" IsToggled="{Binding Preferences.FlattenSmallFolders}" Toggled="OnPrefChanged"/>
						<Label  Grid.Row="4" Grid.Column="1" Text="Flatten tiny folders" />
					</Grid>
				</VerticalStackLayout>
			</Border>

			<!-- Visual overview (bars) -->
			<Border Padding="10" Stroke="#33000000" StrokeThickness="1">
				<Border.StrokeShape>
					<RoundRectangle CornerRadius="8" />
				</Border.StrokeShape>
				<VerticalStackLayout Spacing="6">
					<Label Text="Visual Overview (destinations in current plan)" FontAttributes="Bold" />
					<GraphicsView HeightRequest="180" Drawable="{Binding PlanPreviewDrawable}" />
					<Label Text="(Updates after you Generate Plan.)" FontSize="12" />
				</VerticalStackLayout>
			</Border>

			<!-- Scan preview tree (populated immediately after ScanAsync) -->
			<Border Padding="10" Stroke="#33000000" StrokeThickness="1">
				<Border.StrokeShape>
					<RoundRectangle CornerRadius="8" />
				</Border.StrokeShape>
				<VerticalStackLayout Spacing="6">
					<Label Text="Scan Preview (Current File Tree)" FontAttributes="Bold" />
					<Label Text="{Binding CurrentBreadcrumb}" FontSize="12" LineBreakMode="TailTruncation" />
					<ctrls:CurrentTreeView HeightRequest="420" />
				</VerticalStackLayout>
			</Border>

		</VerticalStackLayout>
	</ScrollView>
</ContentPage>