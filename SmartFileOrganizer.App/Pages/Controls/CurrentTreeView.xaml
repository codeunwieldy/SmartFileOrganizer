<?xml version="1.0" encoding="utf-8" ?>
<ContentView
    x:Class="SmartFileOrganizer.App.Pages.Controls.CurrentTreeView"
    x:Name="Self"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:conv="clr-namespace:SmartFileOrganizer.App.Converters">

	<ContentView.Resources>
		<ResourceDictionary>
			<conv:InverseBoolConverter x:Key="InverseBool" />
			<Style x:Key="FolderLabelStyle" TargetType="Label">
				<Setter Property="TextColor" Value="#2E7D32" />
				<Setter Property="FontAttributes" Value="Bold" />
			</Style>
			<Style x:Key="FileLabelStyle" TargetType="Label">
				<Setter Property="TextColor" Value="#1565C0" />
			</Style>
		</ResourceDictionary>
	</ContentView.Resources>

	<VerticalStackLayout Padding="6" Spacing="2">
		<!-- Root collection: an ObservableCollection<CurrentTreeNode> -->
		<CollectionView ItemsSource="{Binding CurrentRoot}" 
						SelectionMode="None"
						BackgroundColor="Transparent">
			<CollectionView.ItemTemplate>
				<DataTemplate>
					<!-- FOLDER NODE -->
					<Grid Padding="4,2" ColumnDefinitions="*">
						<toolkit:Expander IsExpanded="False" 
										  IsVisible="{Binding IsFolder}"
										  BackgroundColor="Transparent">
							<toolkit:Expander.Header>
								<Grid ColumnDefinitions="Auto,*,Auto" Padding="4,2" ColumnSpacing="8">
									<Grid.GestureRecognizers>
										<TapGestureRecognizer
											Command="{Binding Source={x:Reference Self}, Path=BindingContext.SelectCurrentCommand}"
											CommandParameter="{Binding FullPath}" />
										<DragGestureRecognizer CanDrag="True"
															   DragStarting="OnDragStarting" />
										<DropGestureRecognizer AllowDrop="True" Drop="OnDrop" />
									</Grid.GestureRecognizers>
									
									<!-- Folder icon -->
									<Label Grid.Column="0" 
										   Text="ðŸ“" 
										   FontSize="16"
										   VerticalOptions="Center" />
									   
									<!-- Folder name -->
									<Label Grid.Column="1" 
										   Text="{Binding Name}" 
										   Style="{StaticResource FolderLabelStyle}"
										   VerticalOptions="Center"
										   LineBreakMode="TailTruncation" />
										   
									<!-- File count -->
									<Label Grid.Column="2"
										   Text="{Binding FileCount, StringFormat='({0} files)'}"
										   FontSize="11"
										   TextColor="Gray"
										   VerticalOptions="Center" />
								</Grid>
							</toolkit:Expander.Header>

							<!-- Children (recursive) -->
							<CollectionView ItemsSource="{Binding Children}" 
											SelectionMode="None" 
											Margin="24,0,0,0"
											BackgroundColor="Transparent">
								<CollectionView.ItemTemplate>
									<DataTemplate>
										<StackLayout Padding="2">
											<!-- Folder child -->
											<Grid ColumnDefinitions="Auto,*,Auto" 
												  Padding="4,1" 
												  ColumnSpacing="8"
												  IsVisible="{Binding IsFolder}">
												<Grid.GestureRecognizers>
													<TapGestureRecognizer
														Command="{Binding Source={x:Reference Self}, Path=BindingContext.SelectCurrentCommand}"
														CommandParameter="{Binding FullPath}" />
													<DragGestureRecognizer CanDrag="True" DragStarting="OnDragStarting" />
													<DropGestureRecognizer AllowDrop="True" Drop="OnDrop" />
												</Grid.GestureRecognizers>
												
												<Label Grid.Column="0" 
													   Text="ðŸ“" 
													   FontSize="14"
													   VerticalOptions="Center" />
													   
												<Label Grid.Column="1" 
													   Text="{Binding Name}" 
													   Style="{StaticResource FolderLabelStyle}"
													   VerticalOptions="Center"
													   LineBreakMode="TailTruncation" />
													   
												<Label Grid.Column="2"
													   Text="{Binding FileCount, StringFormat='({0})'}"
													   FontSize="10"
													   TextColor="Gray"
													   VerticalOptions="Center" />
											</Grid>

											<!-- File child -->
											<Grid ColumnDefinitions="Auto,*" 
												  Padding="4,1" 
												  ColumnSpacing="8"
												  IsVisible="{Binding IsFolder, Converter={StaticResource InverseBool}}">
												<Grid.GestureRecognizers>
													<TapGestureRecognizer
														Command="{Binding Source={x:Reference Self}, Path=BindingContext.SelectCurrentCommand}"
														CommandParameter="{Binding FullPath}" />
													<DragGestureRecognizer CanDrag="True" DragStarting="OnDragStarting" />
													<DropGestureRecognizer AllowDrop="True" Drop="OnDrop" />
												</Grid.GestureRecognizers>
												
												<Label Grid.Column="0" 
													   Text="ðŸ“„" 
													   FontSize="14"
													   VerticalOptions="Center" />
													   
												<Label Grid.Column="1" 
													   Text="{Binding Name}" 
													   Style="{StaticResource FileLabelStyle}"
													   VerticalOptions="Center"
													   LineBreakMode="TailTruncation" />
											</Grid>
										</StackLayout>
									</DataTemplate>
								</CollectionView.ItemTemplate>
							</CollectionView>
						</toolkit:Expander>

						<!-- FILE NODE (when not a folder) -->
						<Grid ColumnDefinitions="Auto,*" 
							  Padding="4,2" 
							  ColumnSpacing="8"
							  IsVisible="{Binding IsFolder, Converter={StaticResource InverseBool}}">
							<Grid.GestureRecognizers>
								<TapGestureRecognizer
									Command="{Binding Source={x:Reference Self}, Path=BindingContext.SelectCurrentCommand}"
									CommandParameter="{Binding FullPath}" />
								<DragGestureRecognizer CanDrag="True" DragStarting="OnDragStarting" />
								<DropGestureRecognizer AllowDrop="True" Drop="OnDrop" />
							</Grid.GestureRecognizers>
							
							<!-- File icon -->
							<Label Grid.Column="0" 
								   Text="ðŸ“„" 
								   FontSize="14"
								   VerticalOptions="Center" />
								   
							<!-- File name -->
							<Label Grid.Column="1" 
								   Text="{Binding Name}" 
								   Style="{StaticResource FileLabelStyle}"
								   VerticalOptions="Center"
								   LineBreakMode="TailTruncation" />
						</Grid>
					</Grid>
				</DataTemplate>
			</CollectionView.ItemTemplate>
		</CollectionView>
	</VerticalStackLayout>
</ContentView>